rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Helper function to check if the requesting user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check user role
    function getUserRole() {
      return request.auth != null &&
             request.auth.token.email != null &&
             firestore.exists(/databases/(default)/documents/staff/$(request.auth.token.email)) &&
             firestore.get(/databases/(default)/documents/staff/$(request.auth.token.email)).data.role;
    }

    // Allow all authenticated users to read files
    // Dedicated rules for payment proofs (images uploaded by staff)
    match /payment-proofs/{filePath=**} {
      // Authenticated users can read proofs
      allow read: if isAuthenticated();

      // Authenticated users can create/update image proofs up to 10MB
      // Use request.resource.name/contentType/size per Storage rules semantics
      allow create, update: if isAuthenticated()
        && request.resource.size < 10 * 1024 * 1024
        && request.resource.contentType.matches('image/.*');

      // Only managers can delete proofs
      allow delete: if isAuthenticated() && getUserRole() == 'Manager';
    }

    // Default read access for other objects for authenticated users
    match /{allPaths=**} {
      allow read: if isAuthenticated();
    }
  }
}